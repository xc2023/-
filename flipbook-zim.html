<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>翻书轮播</title>
    <style>
    /* 基础样式 */
    * { margin:0; padding:0; user-select:none; -webkit-tap-highlight-color:transparent; }
    body, html { width:100vw; height:100vh; overflow:hidden; background:#f0f0f0; }
    #{{CONTAINER_ID}} { width:100%; height:100%; position:relative; }
    
    /* ZIM Canvas */
    canvas { position:absolute; z-index:100; pointer-events:none; }
    
    /* 翻页按钮 */
    .nav-btn { position:absolute; top:50%; transform:translateY(-50%); width:50px; height:50px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; cursor:pointer; font-size:24px; z-index:1002; display:flex; align-items:center; justify-content:center; }
    .nav-btn:hover { background:rgba(0,0,0,0.7); }
    .prev-btn { left:20px; }
    .next-btn { right:20px; }
    
    /* 点击区域 */
    .click-container { position:absolute; top:0; left:0; width:100%; height:100%; z-index:999; pointer-events:none; }
    .click-area { position:absolute; background:transparent; cursor:pointer; pointer-events:auto; z-index:1000; }
    .title-display { position:absolute; color:white; padding:8px 12px; border-radius:4px; font-size:12px; text-align:center; width:35%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; pointer-events:none; z-index:1001; text-shadow:2px 2px 6px rgba(0,0,0,0.8); font-weight:bold; }
    .left-area { left:10%; width:35%; height:70%; top:15%; }
    .left-title { left:10%; top:87%; width:35%; }
    .right-area { right:10%; width:35%; height:70%; top:15%; }
    .right-title { right:10%; top:87%; width:35%; }
    
    /* 加载状态 */
    .loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10000; }
    .loading-text { margin-top:15px; color:#333; font-size:14px; }
    .spinner { width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    
    /* 错误提示 */
    .error { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:10001; }
    .error-text { color:#e74c3c; margin-bottom:10px; }
    .retry-btn { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; }
    
    /* 深色模式 */
    @media (prefers-color-scheme: dark) {
        body, html { background:#1a1a1a; }
        .loading { background:rgba(30,30,30,0.9); }
        .loading-text { color:#eee; }
        .error { background:rgba(30,30,30,0.95); }
    }
    </style>
</head>
<body>
    <!-- 加载状态 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">正在加载翻书组件...</div>
    </div>
    
    <!-- 错误提示 -->
    <div class="error" id="errorOverlay">
        <div class="error-text" id="errorText">加载失败</div>
        <button class="retry-btn" id="retryBtn">重试</button>
    </div>
    
    <!-- 主容器 -->
    <div id="{{CONTAINER_ID}}">
        <!-- 翻页按钮 -->
        <button class="nav-btn prev-btn" id="prevBtn">‹</button>
        <button class="nav-btn next-btn" id="nextBtn">›</button>
        
        <!-- 点击区域容器 -->
        <div class="click-container" id="clickContainer"></div>
    </div>
    
    <!-- JavaScript代码 -->
    <script>
        // 数据
        var imageData = {{IMAGE_DATA}};
        console.log('翻书数据:', imageData.length, '条');
        
        // 配置
        var config = {
            zimLocalPath: 'hiker://files/rules/xclunbo/zim/',
            useLocalZIM: true
        };
        
        // 当前状态
        var currentPage = 1;
        var totalPages = Math.ceil(imageData.length / 2);
        var book = null;
        var autoTimer = null;
        var autoDirection = 1;
    </script>
    
    <!-- ZIM库加载 -->
    <script>
        function loadZIMLibs() {
            return new Promise(function(resolve, reject) {
                var loaded = 0;
                var total = 3;
                
                function check() {
                    loaded++;
                    console.log('ZIM库加载:', loaded + '/' + total);
                    
                    if (loaded === total) {
                        setTimeout(function() {
                            if (window.createjs && window.zim && window.icon6) {
                                resolve();
                            } else {
                                reject('ZIM库加载不完整');
                            }
                        }, 500);
                    }
                }
                
                // 加载顺序
                loadScript('createjs.js', check);
                setTimeout(() => loadScript('zim.js', check), 100);
                setTimeout(() => loadScript('icon6.js', check), 200);
            });
        }
        
        function loadScript(filename, callback) {
            var script = document.createElement('script');
            
            // 优先本地
            if (config.useLocalZIM) {
                script.src = config.zimLocalPath + filename + '?t=' + Date.now();
                script.onerror = function() {
                    console.log('本地加载失败:', filename);
                    // 使用远程备用
                    script.src = getRemoteUrl(filename) + '?t=' + Date.now();
                    script.onload = callback;
                    script.onerror = function() {
                        console.log('远程也失败:', filename);
                        callback();
                    };
                };
                script.onload = callback;
            } else {
                script.src = getRemoteUrl(filename) + '?t=' + Date.now();
                script.onload = callback;
                script.onerror = function() {
                    console.log('加载失败:', filename);
                    callback();
                };
            }
            
            document.head.appendChild(script);
        }
        
        function getRemoteUrl(filename) {
            var urls = {
                'createjs.js': 'https://zimjs.org/cdn/1.3.3/createjs.js',
                'zim.js': 'https://zimjs.org/cdn/nft/01/zim.js',
                'icon6.js': 'https://zimjs.org/cdn/icon6.js'
            };
            return urls[filename] || '';
        }
    </script>
    
    <!-- 主初始化 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initFlipBook();
        });
        
        function initFlipBook() {
            updateLoading('正在加载ZIM库...');
            
            // 创建点击区域
            createClickAreas();
            
            // 加载ZIM库
            loadZIMLibs().then(function() {
                console.log('ZIM库加载成功');
                updateLoading('正在创建翻书...');
                setTimeout(createZIMBook, 100);
            }).catch(function(err) {
                console.warn('ZIM库加载失败:', err);
                showError('ZIM库加载失败');
                updateLoading('使用简化版本...');
                setTimeout(createSimpleBook, 1000);
            });
        }
        
        function createClickAreas() {
            var container = document.getElementById('clickContainer');
            container.innerHTML = '';
            
            // 左侧
            var leftArea = document.createElement('div');
            leftArea.className = 'click-area left-area';
            leftArea.id = 'leftClickArea';
            
            var leftTitle = document.createElement('div');
            leftTitle.className = 'title-display left-title';
            leftTitle.id = 'leftTitle';
            
            // 右侧
            var rightArea = document.createElement('div');
            rightArea.className = 'click-area right-area';
            rightArea.id = 'rightClickArea';
            
            var rightTitle = document.createElement('div');
            rightTitle.className = 'title-display right-title';
            rightTitle.id = 'rightTitle';
            
            container.appendChild(leftArea);
            container.appendChild(rightArea);
            container.appendChild(leftTitle);
            container.appendChild(rightTitle);
            
            // 初始更新
            updateClickAreas();
            
            // 绑定点击事件
            bindClickEvents();
        }
        
        function updateClickAreas() {
            var leftIndex = (currentPage - 1) * 2;
            var rightIndex = leftIndex + 1;
            
            // 左侧
            if (leftIndex < imageData.length) {
                var data = imageData[leftIndex];
                document.getElementById('leftTitle').textContent = data.title || '无标题';
                document.getElementById('leftClickArea').dataset.link = data.url || '#';
                document.getElementById('leftClickArea').dataset.item = JSON.stringify(data);
                document.getElementById('leftClickArea').style.display = 'block';
                document.getElementById('leftTitle').style.display = 'block';
            } else {
                document.getElementById('leftClickArea').style.display = 'none';
                document.getElementById('leftTitle').style.display = 'none';
            }
            
            // 右侧
            if (rightIndex < imageData.length) {
                var data = imageData[rightIndex];
                document.getElementById('rightTitle').textContent = data.title || '无标题';
                document.getElementById('rightClickArea').dataset.link = data.url || '#';
                document.getElementById('rightClickArea').dataset.item = JSON.stringify(data);
                document.getElementById('rightClickArea').style.display = 'block';
                document.getElementById('rightTitle').style.display = 'block';
            } else {
                document.getElementById('rightClickArea').style.display = 'none';
                document.getElementById('rightTitle').style.display = 'none';
            }
        }
        
        function bindClickEvents() {
            document.getElementById('clickContainer').addEventListener('click', function(e) {
                if (e.target.classList.contains('click-area')) {
                    var link = e.target.dataset.link;
                    if (link && link !== '#') {
                        window.open(link, '_blank');
                    }
                    e.stopPropagation();
                    e.preventDefault();
                }
            });
        }
    </script>
    
    <!-- ZIM翻书实现 -->
    <script>
        function createZIMBook() {
            try {
                console.log('开始创建ZIM翻书');
                
                var assets = { font: "reuben", src: "https://assets.codepen.io/2104200/Reuben.otf" };
                var width = 1024;
                var height = 768;
                
                // 创建Frame
                var frame = new zim.Frame(zim.FIT, width, height, "rgba(0,0,0,0)", assets);
                
                frame.on("ready", function() {
                    console.log("ZIM Frame准备就绪");
                    
                    var stage = frame.stage;
                    
                    // 设置透明背景
                    var elements = ['zim-frame', 'zim-stage'];
                    elements.forEach(function(id) {
                        var el = document.getElementById(id);
                        if (el) el.style.backgroundColor = 'transparent';
                    });
                    
                    if (frame.canvas) frame.canvas.style.backgroundColor = 'transparent';
                    if (stage.canvas) stage.canvas.style.backgroundColor = 'transparent';
                    
                    // 创建页面
                    createPages(stage, width, height);
                    
                    // 隐藏加载界面
                    hideLoading();
                    
                    // 启动自动轮播
                    startAutoPlay();
                    
                    console.log('ZIM翻书创建完成');
                });
                
                frame.on("error", function(err) {
                    console.error('Frame错误:', err);
                    showError('翻书创建失败');
                });
                
            } catch (error) {
                console.error('创建翻书出错:', error);
                showError('翻书初始化错误');
            }
        }
        
        function createPages(stage, width, height) {
            var imageUrls = imageData.map(item => item.img);
            var imageTitles = imageData.map(item => item.title || '');
            
            // 设置Page样式
            zim.STYLE = {
                Page: {
                    width: width / 2,
                    height: height,
                }
            };
            
            var pages = [];
            
            // 创建所有页面
            for (var i = 0; i < imageUrls.length; i++) {
                var page = new zim.Page();
                page.color = ["#f8f8f8", "#f0f0f0", "#e8e8e8"][i % 3];
                
                // 图片容器
                var imgContainer = new zim.Container({
                    width: 500,
                    height: 750,
                    backgroundColor: "#ffffff",
                    corner: 5
                }).center(page);
                
                // 遮罩
                var mask = new zim.Shape({
                    width: 500,
                    height: 750,
                    color: zim.clear,
                    corner: 5
                });
                imgContainer.mask = mask;
                
                // 加载图片
                var bitmap = new createjs.Bitmap(imageUrls[i]);
                bitmap.image.onload = function() {
                    var scale = Math.min(460 / this.width, 680 / this.height);
                    bitmap.scaleX = bitmap.scaleY = scale;
                    bitmap.x = (0 - this.width * scale) / 2;
                    bitmap.y = (0 - this.height * scale) / 2;
                    imgContainer.addChild(bitmap);
                    
                    // 页码
                    new zim.Label({
                        text: "- " + (i + 1) + " -",
                        size: 20,
                        color: zim.gray.darken(0.3)
                    }).alp(.7).pos(0, 30, zim.CENTER, zim.BOTTOM, page);
                    
                    stage.update();
                };
                
                bitmap.image.onerror = function() {
                    new zim.Label({
                        text: imageTitles[i] || "图片 " + (i + 1),
                        size: 24,
                        color: zim.gray,
                        textAlign: "center"
                    }).center(imgContainer);
                    
                    new zim.Label({
                        text: "- " + (i + 1) + " -",
                        size: 20,
                        color: zim.gray.darken(0.3)
                    }).alp(.7).pos(0, 30, zim.CENTER, zim.BOTTOM, page);
                    
                    stage.update();
                };
                
                pages.push(page);
            }
            
            // 创建Book
            var bookPages = pages.slice();
            if (bookPages.length % 2 !== 0) {
                bookPages.push(new zim.Page());
            }
            
            book = new zim.Book({
                width: bookPages[0].width * 2,
                height: bookPages[0].height,
                pages: bookPages,
                startPage: 1,
                backgroundColor: null,
                drag: true,
                edge: 100,
                flipTime: 800,
                mouse: true,
                touch: true,
                swipe: true,
                swipeDistance: 50,
                allowQuickSwipe: true,
                doublePage: true
            }).center();
            
            console.log('Book创建完成');
            
            // 绑定翻页事件
            bindPageEvents();
            
            stage.update();
        }
        
        function bindPageEvents() {
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');
            
            prevBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    updateClickAreas();
                    if (book && book.prevPage) book.prevPage();
                    resetAutoPlay();
                }
            });
            
            nextBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    updateClickAreas();
                    if (book && book.nextPage) book.nextPage();
                    resetAutoPlay();
                }
            });
            
            // 键盘控制
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') prevBtn.click();
                if (e.key === 'ArrowRight') nextBtn.click();
            });
            
            // Book翻页同步
            if (book) {
                book.on("change", function(e) {
                    var zimPage = e.currentPage;
                    var ourPage = Math.floor((zimPage - 1) / 2) + 1;
                    if (ourPage !== currentPage) {
                        currentPage = ourPage;
                        updateClickAreas();
                    }
                });
            }
        }
    </script>
    
    <!-- 简化版翻书（备用） -->
    <script>
        function createSimpleBook() {
            console.log('创建简化版翻书');
            // 这里可以添加CSS3翻书代码
            // 暂时只显示提示
            showError('ZIM翻书不可用，请检查网络');
        }
    </script>
    
    <!-- 通用功能 -->
    <script>
        function startAutoPlay() {
            if (autoTimer) clearInterval(autoTimer);
            
            autoTimer = setInterval(function() {
                if (autoDirection === 1) {
                    if (currentPage < totalPages) {
                        document.getElementById('nextBtn').click();
                    } else {
                        autoDirection = -1;
                        document.getElementById('prevBtn').click();
                    }
                } else {
                    if (currentPage > 1) {
                        document.getElementById('prevBtn').click();
                    } else {
                        autoDirection = 1;
                        document.getElementById('nextBtn').click();
                    }
                }
            }, 5000);
        }
        
        function resetAutoPlay() {
            if (autoTimer) {
                clearInterval(autoTimer);
                startAutoPlay();
            }
        }
        
        function updateLoading(text) {
            var el = document.getElementById('loadingText');
            if (el) el.textContent = text;
        }
        
        function hideLoading() {
            var el = document.getElementById('loading');
            if (el) el.style.display = 'none';
        }
        
        function showError(text) {
            var el = document.getElementById('errorText');
            if (el) el.textContent = text;
            
            var overlay = document.getElementById('errorOverlay');
            if (overlay) overlay.style.display = 'flex';
        }
        
        // 重试按钮
        document.getElementById('retryBtn').addEventListener('click', function() {
            document.getElementById('errorOverlay').style.display = 'none';
            initFlipBook();
        });
    </script>
</body>
</html>